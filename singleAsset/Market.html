
{{ block global_scripts }}
        <script src="{{ static 'script.js' }}"></script>
        <script src="{{ static 'scriptMarket.js' }}"></script>
        <script src="{{ static 'sCDAstatic/scriptSAssetMarket.js' }}"></script>
        <script src="{{ static 'highcharts/highcharts.js' }}"></script>
        <script src="{{ static 'highcharts/highcharts_accessibility.js' }}"></script>
        <script src="{{ static 'chart.js' }}"></script>
        <script>
            $(document).ready(function() {
                // Set all volume fields to 1 and ensure they're hidden
                $('#limitBidVolume, #limitAskVolume, #transactionBidVolume, #transactionAskVolume')
                    .val(1)
                    .hide();
                
                // Set goods quantity fields to 1 and hide them
                $('#buyA_qty, #buyB_qty')
                    .val(1)
                    .hide();
            });
        </script>
{{ endblock }}

{{ block global_styles }}
        <link rel="stylesheet" href="{{ static 'style.css' }}">
        <style>
            /* Hide volume input fields */
            #limitBidVolume, #limitAskVolume, #transactionBidVolume, #transactionAskVolume {
                display: none !important;
            }
            
            /* Hide goods quantity input fields */
            #buyA_qty, #buyB_qty {
                display: none !important;
            }
            
            /* Hide volume labels */
            table tr th:contains("Volume"), 
            table tr th:contains("volume") {
                display: none !important;
            }
            
            /* Hide the entire volume row in tables */
            table tr:has(th:contains("Volume")),
            table tr:has(th:contains("volume")) {
                display: none !important;
            }
            

        </style>
{{ endblock }}

{{ block title }}
Market Place
{{ endblock }}

{{ block content }}



<style>
/* Larger fonts and more compact layout */
h1 { font-size: 1.4rem; margin-bottom: 3px; }
h3 { font-size: 1.3rem; margin-bottom: 4px; }
h4 { font-size: 1.1rem; margin-bottom: 3px; }
h5 { font-size: 1rem; margin-bottom: 2px; }
p { font-size: 0.9rem; margin-bottom: 1px; }
.div_box { padding: 4px; margin-bottom: 6px; }
.table_box { font-size: 0.85rem; }
.btn { font-size: 1rem; padding: 4px 10px; }
input { font-size: 1rem; }


/* Additional layout fixes */

/* Bootstrap grid layout fixes */
.row { display: flex !important; }
.col-md-4 { flex: 0 0 33.333333% !important; max-width: 33.333333% !important; }
.col-md-4:not(:last-child) { margin-right: 15px; }

/* Override the problematic CSS from style.css */
.div_box { text-align: left !important; height: auto; overflow: visible; }

/* Standardize all button sizes */
.btn {
    width: 120px !important;
    height: 36px !important;
    font-size: 0.9rem !important;
    padding: 6px 12px !important;
    margin: 5px !important;
}
/* Fix for nested rows in asset market */
.market_interface_container .row { display: block; }
.market_interface_container .col-md-6 { display: inline-block; width: 48%; vertical-align: top; }
.market_bid, .market_ask { display: inline-block; width: 48%; vertical-align: top; }
/* Ensure all content is visible */
.market_interface_container { display: block; }
.market_interface_container .row { display: block; }
.market_interface_container .col-md-6 { display: inline-block; width: 48%; }
.market_bid, .market_ask { display: inline-block; width: 48%; }
/* Debug: make sure everything is visible */
.market_interface_container, .market_interface_container * { visibility: visible !important; }

/* Make Trade History more compact */
.trades_container { margin-bottom: 8px; }
.trades_container h4 { margin-bottom: 5px; }

/* Make Messages section compact */
.news_container { margin-bottom: 10px; }
.news_container h4 { margin-bottom: 8px; }

/* Make endowment info box more compact */
#endowmentTable th, #endowmentTable td {
    padding: 1px 4px !important;
    font-size: 0.9rem !important;
}

/* Reduce spacing in main containers */
.endowment-container { margin-bottom: 8px !important; }
.endowment-div { padding: 4px !important; }

/* Reduce spacing between market sections */
.market_interface_container .div_box { 
    padding: 3px !important; 
    margin-bottom: 4px !important; 
}

/* Make goods market more compact */
.goods-market-container .div_box { 
    padding: 3px !important; 
    margin-bottom: 4px !important; 
}

/* Add more space after Goods Market heading */
h3 { margin-bottom: 24px !important; }

/* Reduce spacing in main table layout */
table[style*="border-spacing: 15px"] { 
    border-spacing: 8px !important; 
}

/* Make market containers more compact */
div[style*="background-color: #f8f9fa"] { 
    padding: 10px !important; 
}

/* Reduce spacing between goods sections */
hr { margin: 12px 0 !important; }

/* Make buttons more compact */
.btn { 
    margin: 3px !important; 
    padding: 4px 8px !important; 
}

/* Style the existing oTree timeout to be compact and in top right */
.otree-timer {
    position: fixed !important;
    top: 20px !important;
    right: 20px !important;
    background-color: #f8f9fa !important;
    border: 1px solid #dee2e6 !important;
    border-radius: 5px !important;
    padding: 8px 12px !important;
    font-size: 0.9rem !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
    z-index: 1000 !important;
    min-width: 120px !important;
    text-align: center !important;
    margin: 0 !important;
}
</style>
<noscript>
    <div id="jsError">ERROR: this page runs only with javascript enabled</div>
</noscript>

<div id="endowmentDiv" class="endowment-container row" style="margin-bottom: 12px">
    <div class="endowment-div col-sm div_box" style="padding: 8px;">
    <table id="endowmentTable">
    <tr style="display: none;">
        <th>Your role</th>
        <td id="traderRole">
            {{ if player.isObserver }} Inactive observer {{ else }} Trader {{ endif }}
        </td>
    </tr>
        {{ if not player.isObserver }}
    <tr>
        <th>Asset holding</th>
        <td id="assetsHolding">{{ player.assetsHolding }}</td>
    </tr>
    <tr> {{ if player.allowShort }}
        <th>Your short selling limit</th>
        <td id="capShort">
            {{ player.capShort }}
        </td>
        {{ else }} {{ endif }}
    </tr>
    <tr>
        <th>Money holding</th>
        <td id="cashHolding">{{ player.cashHolding }}</td>
    </tr>
    <tr> {{ if player.allowLong }}
        <th>Your credit limit</th>
        <td id="capLong">{{ player.capLong }}</td>
        {{ else }} {{ endif }}
    </tr>
    <tr>
        <th>Good A holding</th>
        <td id="goodA_qty">{{ player.goodA_qty }}</td>
    </tr>
    <tr>
        <th>Good B holding</th>
        <td id="goodB_qty">{{ player.goodB_qty }}</td>
    </tr>
    <tr style="display: none;">
        <th>Satisfaction points from goods</th>
        <td id="goods_utility">{{ player.goods_utility }}</td>
    </tr>
    <tr>
        <th>Satisfaction points (goods + money)</th>
        <td id="overall_utility">{{ player.overall_utility }}</td>
    </tr>
        {{ else }} {{ endif }}
    </table>
    </div>
</div>

<table style="width: 100%; margin-bottom: 15px; border-collapse: separate; border-spacing: 15px;">
    <tr>
        <!-- Goods Market (left, 1/3 width) -->
        <td style="width: 33.33%; vertical-align: top;">
            <div style="background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; margin-bottom: 0;">
                <h3>Goods Market</h3>
                
                <!-- Good A Section -->
                <h4>Good A</h4>
                <div style="text-align: left; padding-left: 15px;">
                    <p style="margin-bottom: 5px;"><strong>Monetary cost:</strong> 5</p>
                    <p style="margin-bottom: 5px;"><strong>Asset cost:</strong> 1</p>
                    <p style="margin-bottom: 5px;"><strong>Satisfaction points:</strong> 
                        {% if session.config.use_constant_marginal_utility %}
                            {{ session.config.good_a_marginal_utility }}
                        {% else %}
                            <br><table class="table_box" style="font-size: 12px; margin-top: 5px;">
                                <tr><th>Units</th><th>Utility</th></tr>
                                {% for unit, utility in player.goodA_utility_table %}
                                    <tr><td>{{ unit }}</td><td>{{ utility }}</td></tr>
                                {% endfor %}
                            </table>
                        {% endif %}
                    </p>
                </div>
                <button type="button" id="buyA_btn" class="btn btn-success" style="margin-top: 10px;">Buy Good A</button>
                
                <hr style="margin: 20px 0;">
                
                <!-- Good B Section -->
                <h4>Good B</h4>
                <div style="text-align: left; padding-left: 15px;">
                    <p style="margin-bottom: 5px;"><strong>Monetary cost:</strong> 10</p>
                    <p style="margin-bottom: 5px;"><strong>Asset cost:</strong> 3</p>
                    <p style="margin-bottom: 5px;"><strong>Satisfaction points:</strong> 
                        {% if session.config.use_constant_marginal_utility %}
                            {{ session.config.good_b_marginal_utility }}
                        {% else %}
                            <br><table class="table_box" style="font-size: 12px; margin-top: 5px;">
                                <tr><th>Units</th><th>Utility</th></tr>
                                {% for unit, utility in player.goodB_utility_table %}
                                    <tr><td>{{ unit }}</td><td>{{ utility }}</td></tr>
                                {% endfor %}
                            </table>
                        {% endif %}
                    </p>
                </div>
                <button type="button" id="buyB_btn" class="btn btn-success" style="margin-top: 10px;">Buy Good B</button>
            </div>
        </td>
        <!-- Asset Market + Trade History Container (center + right, 2/3 width) -->
        <td colspan="2" style="width: 66.66%; vertical-align: top;">
            <div style="background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; margin-bottom: 0;">
                <h3>Asset Market</h3>
                <table style="width: 100%; border-collapse: separate; border-spacing: 20px;">
                    <tr>
                        <td style="width: 50%; vertical-align: top;">
                            <div class="market_interface_container">
                    <div class="row">
                        <div class="col-12">
                            <h4>Make Offers</h4>
                        </div>
                        <div class="col-md-6">
                            <p><strong>I offer to buy at this price:</strong></p>
                            <input type="number" class="form-control small-numbers" inputmode="numeric" id="limitBidPrice" min="0" style="width: 120px; margin-bottom: 10px;">
                            <input type="number" class="form-control small-numbers" inputmode="numeric" id="limitBidVolume" min="1" value="1" style="display: none;">

                            <button type="button" onclick="sendOffer(is_bid=1)" id="bidOffer" class="otree-btn-next btn btn-primary">Place bid</button>
                        </div>
                        <div class="col-md-6">
                            <p><strong>I offer to sell at this price:</strong></p>
                            <input type="number" class="form-control small-numbers" inputmode="numeric" id="limitAskPrice" min="0" style="width: 120px; margin-bottom: 10px;">
                            <input type="number" class="form-control small-numbers" inputmode="numeric" id="limitAskVolume" min="1" value="1" style="display: none;">

                            <button type="button" onclick="sendOffer(is_bid=0)" id="SendOffer" class="otree-btn-next btn btn-primary">Place ask</button>
                        </div>
                    </div>
                    
                    <hr style="margin: 20px 0;">
                <div class="market_table row">
                    <div class="col-12">
                        <h4>Accept Offers</h4>
                        <!--<p style="text-align: center">Please, select the offer you wish to accept</p>-->
                    </div>
                    <div class="market_bid col-sm">
                        <h5>Bid Offers</h5>
                        <input type="number" class="form-control small-numbers" inputmode="numeric" id="transactionBidVolume" min="1" style="display: inline-block; width: 80px; margin-bottom: 10px;">
                        <table id="bidsTable" class="table_box"><thead><tr><th>Volume</th><th>Price</th></tr></thead><tbody></tbody></table>
                        <button type="button" onclick="sendAcc(is_bid=1)" id="bidAccept" class="otree-btn-next btn btn-primary">Sell an asset</button>
                        <button type="button" onclick="cancelLimit(is_bid=1)" id="cancelBidLimit" class="btn btn-outline-danger">Cancel offer</button>                      
                    </div>
                    <div class="market_ask col-sm">
                        <h5>Ask Offers</h5>
                        <input type="number" class="form-control small-numbers" inputmode="numeric" id="transactionAskVolume" min="1" style="display: inline-block; width: 80px; margin-bottom: 10px;">
                        <table id="asksTable" class="table_box"><thead><tr><th>Volume</th><th>Price</th></tr></thead><tbody></tbody></table>
                        <button type="button" onclick="sendAcc(is_bid=0)" id="askAccept" class="otree-btn-next btn btn-primary">Buy an asset</button>
                        <button type="button" onclick="cancelLimit(is_bid=0)" id="cancelAskLimit" class="btn btn-outline-danger">Cancel offer</button>
                    </div>
                </div>
                    </td>
                    
                    <!-- Trade History Graph (right side) -->
                    <td style="width: 50%; vertical-align: top;">
                        <div id="highchart" style="height: 300px; min-height: 300px;">
                        </div>
                    </td>
                </tr>
                </table>
            </div>
        </td>
</tr>
</table>


<!-- Market Activity at bottom spanning all three columns -->
<div class="row" style="margin-top: 10px;">
    <div class="col-12">
        <div class="trades_container div_box alert-success" style="padding: 8px; margin-bottom: 10px;">
            <h4 style="margin-bottom: 5px;">Market Activity</h4>
            <table id="tradesTable" class="table_box">
                <thead>
                    <tr>
                        <th>Transaction</th>
                        <th>Price</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Messages at bottom spanning all three columns -->
<div class="row" style="margin-top: 10px;">
    <div class="col-12">
        <div class="news_container div_box alert-warning" style="padding: 8px; margin-bottom: 10px;">
            <h4 style="margin-bottom: 5px;">Messages</h4>
            <table id="newsTable" class="table_box"></table>
        </div>
    </div>
</div>

<div class="otree-form-errors alert-info" id="newsBox" style="display: none; text-align: left; margin-top: 35px">
    <p id="news" style="color: green"></p>
    <button type="button" id="newsError" class="btn btn-outline-info">I understood</button>
</div>

{{ endblock }}
