
{{ block global_scripts }}
        <script src="{{ static 'script.js' }}"></script>
        <script src="{{ static 'scriptMarket.js' }}"></script>
        <script src="{{ static 'sCDAstatic/scriptSAssetMarket.js' }}"></script>
        <script src="{{ static 'highcharts/highcharts.js' }}"></script>
        <script src="{{ static 'highcharts/highcharts_accessibility.js' }}"></script>
        <script src="{{ static 'chart.js' }}"></script>
        <script>
            $(document).ready(function() {
                // Set all volume fields to 1 and ensure they're hidden
                $('#limitBidVolume, #limitAskVolume, #transactionBidVolume, #transactionAskVolume')
                    .val(1)
                    .hide();
                
                // Set goods quantity fields to 1 and hide them
                $('#buyA_qty, #buyB_qty')
                    .val(1)
                    .hide();
            });
        </script>
{{ endblock }}

{{ block global_styles }}
        <link rel="stylesheet" href="{{ static 'style.css' }}">
        <style>
            /* Hide volume input fields */
            #limitBidVolume, #limitAskVolume, #transactionBidVolume, #transactionAskVolume {
                display: none !important;
            }
            
            /* Hide goods quantity input fields */
            #buyA_qty, #buyB_qty {
                display: none !important;
            }
            
            /* Hide volume labels */
            table tr th:contains("Volume"), 
            table tr th:contains("volume") {
                display: none !important;
            }
            
            /* Hide the entire volume row in tables */
            table tr:has(th:contains("Volume")),
            table tr:has(th:contains("volume")) {
                display: none !important;
            }
            

        </style>
{{ endblock }}

{{ block title }}
Market Place
{{ endblock }}

{{ block content }}

<style>
/* Smaller fonts and compact layout */
h3 { font-size: 1.3rem; margin-bottom: 15px; }
h4 { font-size: 1.1rem; margin-bottom: 10px; }
h5 { font-size: 1rem; margin-bottom: 8px; }
p { font-size: 0.9rem; margin-bottom: 4px; }
.div_box { padding: 12px; margin-bottom: 15px; }
.table_box { font-size: 0.85rem; }
.btn { font-size: 0.9rem; padding: 6px 12px; }
input { font-size: 0.9rem; }


/* Additional layout fixes */

/* Bootstrap grid layout fixes */
.row { display: flex !important; }
.col-md-4 { flex: 0 0 33.333333% !important; max-width: 33.333333% !important; }
.col-md-4:not(:last-child) { margin-right: 15px; }

/* Override the problematic CSS from style.css */
.div_box { text-align: left !important; height: auto; overflow: visible; }
/* Fix for nested rows in asset market */
.market_interface_container .row { display: block; }
.market_interface_container .col-md-6 { display: inline-block; width: 48%; vertical-align: top; }
.market_bid, .market_ask { display: inline-block; width: 48%; vertical-align: top; }
/* Ensure all content is visible */
.market_interface_container { display: block; }
.market_interface_container .row { display: block; }
.market_interface_container .col-md-6 { display: inline-block; width: 48%; }
.market_bid, .market_ask { display: inline-block; width: 48%; }
/* Debug: make sure everything is visible */
.market_interface_container, .market_interface_container * { visibility: visible !important; }

/* Make Trade History more compact */
.trades_container { margin-bottom: 8px; }
.trades_container h4 { margin-bottom: 5px; }

/* Make Messages section compact */
.news_container { margin-bottom: 10px; }
.news_container h4 { margin-bottom: 8px; }

</style>
<noscript>
    <div id="jsError">ERROR: this page runs only with javascript enabled</div>
</noscript>

<div id="endowmentDiv" class="endowment-container row" style="margin-bottom: 35px">
    <div class="endowment-div col-sm div_box">
    <table id="endowmentTable">
    <tr style="display: none;">
        <th>Your role</th>
        <td id="traderRole">
            {{ if player.isObserver }} Inactive observer {{ else }} Trader {{ endif }}
        </td>
    </tr>
        {{ if not player.isObserver }}
    <tr>
        <th>Asset holding</th>
        <td id="assetsHolding">{{ player.assetsHolding }}</td>
    </tr>
    <tr> {{ if player.allowShort }}
        <th>Your short selling limit</th>
        <td id="capShort">
            {{ player.capShort }}
        </td>
        {{ else }} {{ endif }}
    </tr>
    <tr>
        <th>Money holding</th>
        <td id="cashHolding">{{ player.cashHolding }}</td>
    </tr>
    <tr> {{ if player.allowLong }}
        <th>Your credit limit</th>
        <td id="capLong">{{ player.capLong }}</td>
        {{ else }} {{ endif }}
    </tr>
    <tr>
        <th>Good A holding</th>
        <td id="goodA_qty">{{ player.goodA_qty }}</td>
    </tr>
    <tr>
        <th>Good B holding</th>
        <td id="goodB_qty">{{ player.goodB_qty }}</td>
    </tr>
    <tr style="display: none;">
        <th>Satisfaction points from goods</th>
        <td id="goods_utility">{{ player.goods_utility }}</td>
    </tr>
    <tr>
        <th>Satisfaction points (goods + money)</th>
        <td id="overall_utility">{{ player.overall_utility }}</td>
    </tr>
        {{ else }} {{ endif }}
    </table>
    </div>
</div>

<table style="width: 100%; margin-bottom: 15px; border-collapse: separate; border-spacing: 15px;">
    <tr>
        <!-- Goods Market (left, 1/3 width) -->
        <td style="width: 33.33%; vertical-align: top;">
            <h3>Goods Market</h3>
            
            <!-- Good A Box -->
            <div class="div_box" style="margin-bottom: 15px;">
                <h4>Good A</h4>
                <div style="text-align: left; padding-left: 15px;">
                    <p style="margin-bottom: 5px;"><strong>Monetary cost:</strong> 5</p>
                    <p style="margin-bottom: 5px;"><strong>Asset cost:</strong> 1</p>
                    <p style="margin-bottom: 5px;"><strong>Satisfaction points:</strong> 
                        {% if session.config.use_constant_marginal_utility %}
                            {{ session.config.good_a_marginal_utility }}
                        {% else %}
                            <br><table class="table_box" style="font-size: 12px; margin-top: 5px;">
                                <tr><th>Units</th><th>Utility</th></tr>
                                {% for unit, utility in player.goodA_utility_table %}
                                    <tr><td>{{ unit }}</td><td>{{ utility }}</td></tr>
                                {% endfor %}
                            </table>
                        {% endif %}
                    </p>
                </div>
                <button type="button" id="buyA_btn" class="btn btn-success" style="margin-top: 10px;">Buy Good A</button>
            </div>
            
            <!-- Good B Box -->
            <div class="div_box" style="margin-bottom: 15px;">
                <h4>Good B</h4>
                <div style="text-align: left; padding-left: 15px;">
                    <p style="margin-bottom: 5px;"><strong>Monetary cost:</strong> 10</p>
                    <p style="margin-bottom: 5px;"><strong>Asset cost:</strong> 3</p>
                    <p style="margin-bottom: 5px;"><strong>Satisfaction points:</strong> 
                        {% if session.config.use_constant_marginal_utility %}
                            {{ session.config.good_b_marginal_utility }}
                        {% else %}
                            <br><table class="table_box" style="font-size: 12px; margin-top: 5px;">
                                <tr><th>Units</th><th>Utility</th></tr>
                                {% for unit, utility in player.goodB_utility_table %}
                                    <tr><td>{{ unit }}</td><td>{{ utility }}</td></tr>
                                {% endfor %}
                            </table>
                        {% endif %}
                    </p>
                </div>
                <button type="button" id="buyB_btn" class="btn btn-success" style="margin-top: 10px;">Buy Good B</button>
            </div>
        </td>
        <!-- Asset Market (center, 1/3 width) -->
        <td style="width: 33.33%; vertical-align: top;">
            <h3>Asset Market</h3>
            <div class="market_interface_container div_box">
                    <div class="row">
                        <div class="col-12">
                            <h4>Make Offers</h4>
                        </div>
                        <div class="col-md-6">
                            <p><strong>I offer to buy at this price:</strong></p>
                            <input type="number" class="form-control small-numbers" inputmode="numeric" id="limitBidPrice" min="0" style="width: 120px; margin-bottom: 10px;">
                            <input type="number" class="form-control small-numbers" inputmode="numeric" id="limitBidVolume" min="1" value="1" style="display: none;">

                            <button type="button" onclick="sendOffer(is_bid=1)" id="bidOffer" class="otree-btn-next btn btn-primary">Place bid offer</button>
                            <div class="otree-form-errors alert alert-danger" id="errorBidOffer" style="display: none; text-align: left; margin-top: 35px">
                                <p>Please provide all necessary information to place a bid offer</p>
                                <ol>
                                    <li>Provide the desired volume (a positive valued integer).</li>
                                    <li>Provide the desired price you offer to pay (a positive valued real number).</li>
                                </ol>
                                <button type="button" id="sendBidError" class="btn btn-outline-danger">I understood</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <p><strong>I offer to sell at this price:</strong></p>
                            <input type="number" class="form-control small-numbers" inputmode="numeric" id="limitAskPrice" min="0" style="width: 120px; margin-bottom: 10px;">
                            <input type="number" class="form-control small-numbers" inputmode="numeric" id="limitAskVolume" min="1" value="1" style="display: none;">

                            <button type="button" onclick="sendOffer(is_bid=0)" id="SendOffer" class="otree-btn-next btn btn-primary">Place ask offer</button>
                            <div class="otree-form-errors alert alert-danger" id="errorAskOffer" style="display: none; text-align: left; margin-top: 35px">
                                <p>Please provide all necessary information to place an ask offer</p>
                                <ol>
                                    <li>Provide the desired volume (a positive valued integer).</li>
                                    <li>Provide the desired price you seek to receive (a positive valued real number).</li>
                                </ol>
                                <button type="button" id="sendAskError" class="btn btn-outline-danger">I understood</button>
                            </div>
                        </div>
                    </div>
                    
                    <hr style="margin: 20px 0;">
                <div class="market_table row">
                    <div class="col-12">
                        <h4>Accept Offers</h4>
                        <!--<p style="text-align: center">Please, select the offer you wish to accept</p>-->
                    </div>
                    <div class="market_bid col-sm">
                        <h5>Bid Offers</h5>
                        <input type="number" class="form-control small-numbers" inputmode="numeric" id="transactionBidVolume" min="1" style="display: inline-block; width: 80px; margin-bottom: 10px;">
                        <table id="bidsTable" class="table_box"><thead><tr><th>Volume</th><th>Price</th></tr></thead><tbody></tbody></table>
                        <button type="button" onclick="sendAcc(is_bid=1)" id="bidAccept" class="otree-btn-next btn btn-primary">Sell an asset</button>
                        <button type="button" onclick="cancelLimit(is_bid=1)" id="cancelBidLimit" class="btn btn-outline-danger">Cancel own offer</button>
                        
                        <div class="otree-form-errors alert alert-danger" id="errorBidMarket" style="display: none; text-align: left; margin-top: 35px;">
                            <p>Please provide all necessary information to accept a bid offer</p>
                            <ol>
                                <li>Select the offer you wish to accept</li>
                                <li>The demanded offer shall not be one you placed but blue-framed instead.</li>
                                <li>The demanded offer shall be one with the best available price (placed at the top of the table).</li>
                                <li>Provide the desired volume you wish to take (a positive valued integer).</li>
                            </ol>
                            <button type="button" id="accBidError" class="btn btn-outline-danger">I understood</button>
                        </div>
                        <div class="otree-form-errors alert alert-danger" id="errorBidCancel" style="display: none; text-align: left; margin-top: 35px;">
                            <p>If you wish to withdraw one of your own (red-framed) bid offers, please select it first.</p>
                            <button type="button" id="cancelBidError" class="btn btn-outline-danger">I understood</button>
                        </div>
                    </div>
                    <div class="market_ask col-sm">
                        <h5>Ask Offers</h5>
                        <input type="number" class="form-control small-numbers" inputmode="numeric" id="transactionAskVolume" min="1" style="display: inline-block; width: 80px; margin-bottom: 10px;">
                        <table id="asksTable" class="table_box"><thead><tr><th>Volume</th><th>Price</th></tr></thead><tbody></tbody></table>
                        <button type="button" onclick="sendAcc(is_bid=0)" id="askAccept" class="otree-btn-next btn btn-primary">Buy an asset</button>
                        <button type="button" onclick="cancelLimit(is_bid=0)" id="cancelAskLimit" class="btn btn-outline-danger">Cancel own offer</button>
                        <div class="otree-form-errors alert alert-danger" id="errorAskMarket" style="display: none; text-align: left; margin-top: 35px">
                            <p>Please provide all necessary information to accept an ask offer</p>
                            <ol>
                                <li>Select the offer you wish to accept</li>
                                <li>The demanded offer shall not be one you placed but blue-framed instead.</li>
                                <li>The demanded offer shall be one with the best available price (placed at the top of the table).</li>
                                <li>Provide the desired volume you wish to take (a positive valued integer).</li>
                            </ol>
                            <button type="button" id="accAskError" class="btn btn-outline-danger">I understood</button>
                        </div>
                        <div class="otree-form-errors alert alert-danger" id="errorAskCancel" style="display: none; text-align: left; margin-top: 35px;">
                            <p>If you wish to withdraw one of your own (red-framed) ask offers, please select it first.</p>
                            <button type="button" id="cancelAskError" class="btn btn-outline-danger">I understood</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
        </div>
    </td>
    <!-- Trade History (right, 1/3 width) -->
    <td style="width: 33.33%; vertical-align: top;">
        <h3>Trade History</h3>
        <div id="highchart" class="div_box" style="height: 300px; min-height: 300px;">
        </div>
    </td>
</tr>
</table>


<!-- Market Activity at bottom spanning all three columns -->
<div class="row" style="margin-top: 10px;">
    <div class="col-12">
        <div class="trades_container div_box alert-success" style="padding: 8px; margin-bottom: 10px;">
            <h4 style="margin-bottom: 5px;">Market Activity</h4>
            <table id="tradesTable" class="table_box">
                <thead>
                    <tr>
                        <th>Transaction</th>
                        <th>Price</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Messages at bottom spanning all three columns -->
<div class="row" style="margin-top: 10px;">
    <div class="col-12">
        <div class="news_container div_box alert-warning" style="padding: 8px; margin-bottom: 10px;">
            <h4 style="margin-bottom: 5px;">Messages</h4>
            <table id="newsTable" class="table_box"></table>
        </div>
    </div>
</div>

<div class="otree-form-errors alert-info" id="newsBox" style="display: none; text-align: left; margin-top: 35px">
    <p id="news" style="color: green"></p>
    <button type="button" id="newsError" class="btn btn-outline-info">I understood</button>
</div>

{{ endblock }}
